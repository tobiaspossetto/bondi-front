
import React, { useEffect, useState } from 'react';
import { Circle, MapContainer, Marker, Polyline, Popup, Rectangle, TileLayer } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import Markers, { bondiHue, BondiMarker } from './Markers';
import MyLocation from './MyLocation';
import { Pos } from './types';
import b from '../lines/b.json';
import {useImmer} from 'use-immer';
import socket from './socket';
import {z} from 'zod';


const C: [number, number][] = [
  [-31.435644783154306, -62.11266700794385],
  [-31.43144523325101, -62.111693366088225,],
  [-31.435441087767437, -62.08745082109501],
  [-31.435445664840817, -62.08682318420538],
  [-31.435379057626488, -62.08635032529959],
  [-31.43559213107089, -62.08592196200486],
  [-31.435734020013033, -62.08538552021886],
  [-31.435885062844456, -62.08421607712533],
  [-31.435885062815515, -62.084194619433696],
  [-31.431152271695847, -62.0831378290742],
  [-31.430404529803273, -62.08799586909407],
  [-31.429092136842474, -62.08767452154318],
  [-31.428993723046023, -62.08824583204528],
  [-31.426260982377453, -62.08764769942801],
  [-31.426393730403163, -62.08657481582801],
  [-31.42656767581994, -62.08549388562917],
  [-31.426753064666507, -62.084321760288056],
  [-31.42519899131813, -62.083884560218564],
  [-31.42499300026633, -62.08370216998995],
  [-31.424812185540123, -62.08379068288463],
  [-31.42399050408242, -62.08369680556235],
  [-31.422184610628488, -62.08330252083062],
  [-31.422363141566716, -62.08226182372944],
  [-31.422539383311754, -62.081084334009134],
  [-31.422857533160123, -62.07922556317343],
  [-31.42303606282402, -62.07806684883949],
  [-31.42325350233003, -62.07669355786729],
  [-31.42304521818097, -62.07661845598679],
  [-31.423963038279354, -62.0755294791242],
  [-31.42859320070566, -62.070076548212874],
  [-31.42728634165545, -62.06856378231921],
  [-31.4253042754408, -62.06628390462025],
  [-31.423564783286423, -62.068370663235456],
  [-31.420822818569455, -62.06521647803688],
  [-31.41673632872393, -62.06428386257783],
  [-31.417198281089544, -62.06149611415712],
  [-31.41952340681072, -62.06227199233533],
  [-31.43072719364356, -62.06599980860323],
  [-31.42921066031475, -62.06780417655071],
  [-31.426188653608765, -62.07135937018945],
  [-31.42815173760915, -62.073614830142745],
  [-31.429148660608554, -62.07466587445642],
  [-31.42937960650645, -62.07473353825265],
  [-31.431138625793423, -62.07513952103559],
  [-31.430634402644117, -62.078310697703245],
  [-31.429964316522177, -62.08233361825357],
  [-31.43129801474818, -62.08265749086522],
  [-31.429757168543134, -62.09201445110188],
[-31.42978900152977, -62.09203904431329],
[-31.431675333532073, -62.09243447660466],
[-31.432418940574212, -62.0879059037527],
[-31.437954043759845, -62.08912348656267],
[-31.43778698490704, -62.09018295912534],
[-31.440981721301355, -62.09087521082814],
[-31.44039779712734, -62.094412311543394],
[-31.44320797214578, -62.09502247124247],
[-31.44232237760895, -62.100153537089746],
[-31.43955329504314, -62.09957909984632],
[-31.43835279990215, -62.10689991937692],
[-31.43661198381244, -62.10649001253652],
[-31.43562703041716, -62.11264438506973]

 
];

const B = b as [number, number][];

// const B: [number, number][] = [
//   [-31.44587292431336, -62.07864672240045],
//   [-31.446777428268287, -62.07329749527647],
//   [-31.445953930564073, -62.073122422843305],
//   [-31.445538142941405, -62.075753236325674],
//   [-31.441622400887066, -62.07492992054791],
//   [-31.442103768647403, -62.072073833261946],
//   [-31.43802851855267, -62.07121274181651],
//   [-31.436770130422442, -62.07855783039864],
//   [-31.43591327149303, -62.078348619882654],
//   [-31.436243558220713, -62.076209547938674],
//   [-31.434423013539877, -62.07583339475026],
//   [-31.43494363000793, -62.07268676091452],
//   [-31.433013384711153, -62.072233357138224],
//   [-31.42974981170346, -62.091999475693115], // Bs. As.
//   [-31.41568092509902, -62.088899632305186], // Rosario de Sta. Fe
//   // Rotonda Maipu
//   [-31.415119935445432, -62.092472941454965], // Entrada
//   [-31.41447060114935, -62.09344717219944],
//   [-31.41442908464054, -62.09373421443667],
//   [-31.41459931826385, -62.09406017481644],
//   [-31.414802765151244, -62.09411368909888], // Salida
//   [-31.414835982358575, -62.09436667508543], // Rosario de Sta. Fe
//   [-31.41348243959119, -62.10226274213337], // Honduras
//   // J. Hernandez
//   [-31.416305764453583, -62.1028952079542],
//   [-31.416666979876933, -62.10042373494825], // Curvita
//   [-31.416720953020146, -62.100165885099244],
//   [-31.4167956857928, -62.100039392202795],
//   [-31.416968896515137, -62.09904566802386], // Ecuador
//   [-31.42224605403873, -62.10019542103638], // Roca
//   [-31.421040095695357, -62.10747529231243], // Pavón
//   [-31.422945264985323, -62.107890526381], // Cabrera
//   [-31.425199423417133, -62.09430716889539], // 25 de Mayo
//   [-31.42799773574981, -62.09484332628941], // Roldan
//   [-31.42851773574981, -62.09174332628941], // Bs. As.
//   // J.B. Justo
//   [-31.429151465676313, -62.09187003117571],
//   [-31.429315113048247, -62.091870954122136],
//   [-31.429902633341193, -62.09203260331729], // 9 de Julio
//   [-31.43184965777836, -62.079963038030364], // Echeverria
//   [-31.440528688012936, -62.08195202154451], // 9 de Septiembre
//   [-31.44121021099998, -62.077631911209096], // 1° Mayo
// ];

B.push(B[0]);

const A: [number, number][] = [
  [-31.420788135887587, -62.10935408260213],
  [-31.426253856546097, -62.11054498340496],
  [-31.431491122395517, -62.11173553214557],
  [-31.431912229963846, -62.108685860490084],
  [-31.430067581730047, -62.10822988495897],
  [-31.429820405267936, -62.10823524937701],
  [-31.428717257915217, -62.107999214983174],
  [-31.429280276650992, -62.104737648817476],
  [-31.432434034550898, -62.10549403176253],
  [-31.43534510152396, -62.10616994843418],
  [-31.436622097658123, -62.09891189083686],
  [-31.43264458645808, -62.0979945753575],
  [-31.432987876586896, -62.09598828301496],
  [-31.43396739084117, -62.09622431740792],
  [-31.43544515469253, -62.087356178531486],
  [-31.435449731765708, -62.08680900789123],
  [-31.435408538099054, -62.086358396775715],
  [-31.435619083331126, -62.085870234740604],
  [-31.435756395174483, -62.08537670828077],
  [-31.435939477319405, -62.08418044305744],
  [-31.43131490078851, -62.08318127623016],
  [-31.42972199554003, -62.09205402365464],
  [-31.431679777360834, -62.092463169523704],
  [-31.43226689671217, -62.088962746140595],
  [-31.430451812652617, -62.08854595287425],
  [-31.430538781627224, -62.088020239908296],
  [-31.429094628277863, -62.08767691715364],
  [-31.428980193618955, -62.088232134419826],
  [-31.426263473876094, -62.087658141690625],
  [-31.42638477811739, -62.08664158447161],
  [-31.4264076656928, -62.08651015623051],
  [-31.42676928864422, -62.08431610925422],
  [-31.425203771624517, -62.083905731277724],
  [-31.42502295729488, -62.083699201183606],
  [-31.42476432354695, -62.08380648954436],
  [-31.42380760134098, -62.08369651897575],
  [-31.422193968816334, -62.083318327504756],
  [-31.422523564099265, -62.08121547563576],
  [-31.422963022668757, -62.07859495742684],
  [-31.42322273016257, -62.07666816475585],
  [-31.419777970156087, -62.07592787507042],
  [-31.418681571487134, -62.082555613549054],
  [-31.414839302605497, -62.081762758712436],
  [-31.41514950114009, -62.08020690836974],
  [-31.406890033335404, -62.07842563373544],
  [-31.406551226153134, -62.07999204380064],
  [-31.41211849713909, -62.081215131110255],
  [-31.412420658641153, -62.081215131110255],
  [-31.414847071790028, -62.08177303058632],
  [-31.416606467024856, -62.082184486828105],
  [-31.41696842921274, -62.082283560225214],
  [-31.417929799115086, -62.082498136947294],
  

]

const fillBlueOptions = { fillColor: 'blue' };
const lineStyleA = { color: `hsl(${bondiHue("A")}deg, 100%, 30%)`, borderStyle: 'dotted', borderWidth: 90 };
const lineStyleB = { color: `hsl(${bondiHue("B")}deg, 100%, 30%)`, borderStyle: 'dotted', borderWidth: 90 };
const lineStyleC = { color: `hsl(${bondiHue("C")}deg, 100%, 30%)`, borderStyle: 'dotted', borderWidth: 90 };

const testCC: [number, number] = [-31.42799773574981, -62.09484332628941];

interface MapViewProps {
  position: Pos;
  className: string;
}

interface BondiData {
  lineName: string;
  unitName: string;
  coord: Pos;
}

const Bondis = z.record(
  z.string(), z.record(
    z.string(), z.tuple([z.number(), z.number()])
  )
)
type Bondis = z.infer<typeof Bondi>

const MapView = ({ position, className }: MapViewProps) => {
  const [bondis, produceBondis] = useImmer<Bondis>({})

  useEffect(() => {
    function onData(data: BondiData) {
      produceBondis(draft => {
        const line = draft[data.lineName] ?? {}
        line[data.unitName] = data.coord
        draft[data.lineName] = line
      })
    }
    socket.on("COORDENADAS", onData)
    return () => {
      socket.off("COORDENADAS", onData)
    }
  }, [line])

  
  return (
    <MapContainer className={className} center={[-31.424528037992335, -62.07158078019124]} zoom={16} minZoom={14} scrollWheelZoom={true}>

      <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' />
      <BondiMarker line='A' />
      <BondiMarker line='B' />
      <BondiMarker line='C' />
      {/* <BondiMarker line='d' position={[-31.41975754067003, -62.08235078378741]} />
      <BondiMarker line='e' position={[-31.42075754067003, -62.08235078378741]} />
      <BondiMarker line='f' position={[-31.42175754067003, -62.08235078378741]} />
      <BondiMarker line='g' position={[-31.42275754067003, -62.08235078378741]} />
      <BondiMarker line='h' position={[-31.42375754067003, -62.08235078378741]} />
      <BondiMarker line='i' position={[-31.42475754067003, -62.08235078378741]} /> */}
      <Polyline pathOptions={lineStyleA} positions={A} />
      <Polyline pathOptions={lineStyleB} positions={B} />
      <Polyline pathOptions={lineStyleC} positions={C} />

      <MyLocation change={position} />

    </MapContainer>
  );
};


export default MapView;
